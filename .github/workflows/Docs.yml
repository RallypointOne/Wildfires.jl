name: Docs

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      # Determine deploy target from ref
      - name: Set deploy version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "is_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "version=dev" >> "$GITHUB_OUTPUT"
            echo "is_release=false" >> "$GITHUB_OUTPUT"
          fi

      # Build docs
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'
      - uses: julia-actions/cache@v2
      - name: Install docs dependencies
        run: julia --project=docs -e 'using Pkg; Pkg.develop(path="."); Pkg.instantiate()'
      - name: Install lcov
        run: sudo apt-get install -y lcov
      - name: Fetch benchmark results
        run: git fetch origin benchmark-results || true
      - name: Add benchmarks page if results exist
        run: |
          if git show origin/benchmark-results:results.json >/dev/null 2>&1 && [ -f docs/resources/benchmarks.qmd ]; then
            sed -i '/- resources\/changelog.qmd/i\        - resources/benchmarks.qmd' docs/_quarto.yml
          fi
      - uses: quarto-dev/quarto-actions/setup@v2
      - name: Set build date
        run: sed -i "s/__BUILD_DATE__/$(date -u +'%Y-%m-%d')/" docs/_quarto.yml
      - uses: quarto-dev/quarto-actions/render@v2
        with:
          path: docs

      # Deploy to gh-pages branch
      - name: Deploy to gh-pages
        env:
          VERSION: ${{ steps.version.outputs.version }}
          IS_RELEASE: ${{ steps.version.outputs.is_release }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch or create orphan
          if git ls-remote --exit-code origin gh-pages; then
            git clone --branch gh-pages --single-branch "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" gh-pages-deploy
          else
            mkdir gh-pages-deploy
            cd gh-pages-deploy
            git init
            git checkout --orphan gh-pages
            git commit --allow-empty -m "Initialize gh-pages"
            cd ..
          fi

          # Copy built docs to version directory
          rm -rf "gh-pages-deploy/${VERSION}"
          cp -r docs/_site "gh-pages-deploy/${VERSION}"

          cd gh-pages-deploy

          # If release tag: update versions.json and stable redirect
          if [ "$IS_RELEASE" = "true" ]; then
            # Update versions.json
            if [ -f versions.json ]; then
              # Add new version and sort by semver descending
              python3 -c "
          import json, re
          with open('versions.json') as f:
              versions = json.load(f)
          ver = '${VERSION}'
          if ver not in versions:
              versions.append(ver)
          def semver_key(v):
              nums = re.findall(r'\d+', v)
              return tuple(int(n) for n in nums)
          versions.sort(key=semver_key, reverse=True)
          with open('versions.json', 'w') as f:
              json.dump(versions, f, indent=2)
          "
            else
              echo "[\"${VERSION}\"]" > versions.json
            fi

            # Update stable redirect
            mkdir -p stable
            cat > stable/index.html << STABLE_EOF
          <!DOCTYPE html>
          <html>
          <head><meta http-equiv="refresh" content="0; url=/${REPO_NAME}/${VERSION}/"></head>
          <body>Redirecting to <a href="/${REPO_NAME}/${VERSION}/">latest stable</a>...</body>
          </html>
          STABLE_EOF
          fi

          # Create stable placeholder if no releases yet
          if [ ! -d stable ]; then
            mkdir -p stable
            cat > stable/index.html << PLACEHOLDER_EOF
          <!DOCTYPE html>
          <html>
          <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>${REPO_NAME} â€” No Stable Release Yet</title>
          <meta http-equiv="refresh" content="5; url=/${REPO_NAME}/dev/">
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
          </head>
          <body class="d-flex align-items-center justify-content-center min-vh-100 bg-light">
          <div class="text-center p-5">
          <h1 class="mb-3">${REPO_NAME}</h1>
          <p class="lead text-muted">No stable version has been released yet.<br>Redirecting to the <a href="/${REPO_NAME}/dev/">development docs</a> in 5 seconds...</p>
          </div>
          </body>
          </html>
          PLACEHOLDER_EOF
          fi

          # Always update root redirect to stable
          cat > index.html << ROOT_EOF
          <!DOCTYPE html>
          <html>
          <head><meta http-equiv="refresh" content="0; url=/${REPO_NAME}/stable/"></head>
          <body>Redirecting to <a href="/${REPO_NAME}/stable/">stable docs</a>...</body>
          </html>
          ROOT_EOF

          touch .nojekyll

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy"
          else
            git commit -m "Deploy docs: ${VERSION}"
            git push "https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git" HEAD:gh-pages
          fi
