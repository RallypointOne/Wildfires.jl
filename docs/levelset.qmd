---
title: "Level Set"
engine: julia
---

```{julia}
#| echo: false
#| output: false
using Wildfires
using Wildfires.LevelSet
using CairoMakie
```

The `LevelSet` module implements a fire spread simulator using the **level set method**.  A signed distance function `φ(x, y, t)` implicitly tracks the fire front:

| Region | Condition | Meaning |
|--------|-----------|---------|
| Burned | `φ < 0` | Fire has passed |
| Front | `φ = 0` | Active fire perimeter |
| Unburned | `φ > 0` | Fuel ahead of fire |

The front evolves according to the Hamilton-Jacobi equation:

$$\frac{\partial \phi}{\partial t} + F |\nabla \phi| = 0$$

where $F(x, y, t) \geq 0$ is the local spread rate (e.g. from the [Rothermel model](rothermel.qmd)).

## `LevelSetGrid`

```{julia}
grid = LevelSetGrid(100, 100, dx=30.0)
```

## Boundary Conditions

The `bc` keyword controls how the solver handles grid edges.  Three built-in options are available:

| Type | Behavior |
|------|----------|
| `ZeroNeumann()` | Zero-gradient at edges (default).  Missing neighbors contribute zero to finite differences. |
| `Dirichlet()` | Fixed-value edges.  Edge cells are never updated by `advance!` or `reinitialize!`. |
| `Periodic()` | Wrap-around.  Edges reference values from the opposite side of the grid. |

```{julia}
grid_d = LevelSetGrid(50, 50, dx=30.0, bc=Dirichlet())
grid_p = LevelSetGrid(50, 50, dx=30.0, bc=Periodic())
println("Dirichlet: ", grid_d)
println("Periodic:  ", grid_p)
```

Custom boundary conditions can be defined by subtyping `AbstractBoundaryCondition` and implementing the `_Dxm`, `_Dxp`, `_Dym`, `_Dyp` helper functions (see source for signatures).

### Coordinates

```{julia}
xs = xcoords(grid)
println("x: $(first(xs)) to $(last(xs)) m  ($(length(xs)) cells)")

ys = ycoords(grid)
println("y: $(first(ys)) to $(last(ys)) m  ($(length(ys)) cells)")
```

## Ignition

```{julia}
ignite!(grid, 1500.0, 1500.0, 100.0)
grid
```

## Queries

```{julia}
burn_area(grid)  # m²
```

```{julia}
sum(burned(grid))  # number of burned cells
```

## Advancing the Front

The spread rate field `F` has the same dimensions as the grid.  Each cell specifies the local spread rate in m/min.

```{julia}
F = fill(10.0, size(grid))  # uniform 10 m/min everywhere

for _ in 1:20
    advance!(grid, F, 0.5)
end

grid
```

### Godunov's Upwind Scheme

The `advance!` function computes $|\nabla\phi|$ using **Godunov's upwind scheme**, a monotone numerical flux for Hamilton-Jacobi equations.  The idea is to use one-sided (upwind) finite differences that respect the direction information is traveling — toward the fire front.

At each cell, four one-sided differences are computed:

$$D_x^- = \frac{\phi_{i,j} - \phi_{i,j-1}}{\Delta x}, \quad D_x^+ = \frac{\phi_{i,j+1} - \phi_{i,j}}{\Delta x}$$

$$D_y^- = \frac{\phi_{i,j} - \phi_{i-1,j}}{\Delta y}, \quad D_y^+ = \frac{\phi_{i+1,j} - \phi_{i,j}}{\Delta y}$$

Since the spread rate $F \geq 0$, the front moves in the direction of $\nabla\phi$ (outward from burned regions).  Godunov's scheme selects the appropriate one-sided difference in each coordinate:

$$\hat{D}_x = \max\!\bigl(\max(D_x^-,\, 0),\; -\min(D_x^+,\, 0)\bigr)$$

$$\hat{D}_y = \max\!\bigl(\max(D_y^-,\, 0),\; -\min(D_y^+,\, 0)\bigr)$$

Then $|\nabla\phi| \approx \sqrt{\hat{D}_x^2 + \hat{D}_y^2}$ and the update is:

$$\phi^{n+1}_{i,j} = \phi^n_{i,j} - \Delta t \; F_{i,j} \; \sqrt{\hat{D}_x^2 + \hat{D}_y^2}$$

This selection rule ensures that only **upstream** information influences the update, preventing oscillations that would occur with central differences.  At domain boundaries, the one-sided differences that would require out-of-bounds data are set to zero (implicit zero-Neumann / reflective boundary condition).

### CFL Condition

The time step `dt` must satisfy the **Courant-Friedrichs-Lewy (CFL) condition** for numerical stability:

$$\text{dt} \leq \text{cfl} \cdot \frac{\min(\text{dx}, \text{dy})}{\max(F)}$$

where `cfl` is a safety coefficient (default `0.5`).  If `dt` is too large, the upwind scheme becomes unstable and `φ` values will diverge.

The `cfl_dt` function computes a stable time step:

```{julia}
F = fill(10.0, size(grid))
cfl_dt(grid, F)           # cfl=0.5 by default
```

```{julia}
cfl_dt(grid, F; cfl=1.0)  # less conservative
```

The `simulate!` function uses automatic CFL-limited time stepping by default.  Pass an explicit `dt` to override:

```julia
simulate!(grid, model, steps=100)           # auto CFL (recommended)
simulate!(grid, model, steps=100, dt=0.5)   # fixed dt (user must ensure stability)
```

## Reinitialization

Over many time steps, `φ` can drift away from a true signed distance function (gradients become too flat or too steep).  Periodic reinitialization restores `|∇φ| ≈ 1`, which keeps the upwind scheme accurate.

```{julia}
reinitialize!(grid)
grid
```

## Plotting

### Standard Makie Plots

The `LevelSetGrid` integrates with Makie's `heatmap`, `contour`, `contourf`, and `surface` via `convert_arguments`:

```{julia}
fig = Figure(size=(700, 300))
ax1 = Axis(fig[1, 1], title="heatmap", aspect=DataAspect())
heatmap!(ax1, grid, colormap=:RdYlGn)

ax2 = Axis(fig[1, 2], title="contourf", aspect=DataAspect())
contourf!(ax2, grid, colormap=:RdYlGn)
fig
```

### `fireplot`

The `fireplot` recipe combines a heatmap of `φ` with a contour line at the fire front:

```{julia}
fig = Figure()
ax = Axis(fig[1, 1], title="t = $(grid.t) min", aspect=DataAspect(),
    xlabel="x (m)", ylabel="y (m)")
fireplot!(ax, grid)
fig
```

## Full Example

Simulate fire spread with a spatially varying spread rate and visualize snapshots:

```{julia}
# Fresh grid with ignition
g = LevelSetGrid(200, 200, dx=15.0)
ignite!(g, 1500.0, 1500.0, 50.0)

# Spread rate: faster on the right side
F = [5.0 + 10.0 * (j / 200)
    for i in 1:200, j in 1:200]

fig = Figure(size=(700, 250))
times = [0, 50, 100]
for (col, target_t) in enumerate(times)
    while g.t < target_t
        advance!(g, F, 0.25)
    end
    col > 1 && reinitialize!(g)
    t = round(g.t, digits=1)
    ax = Axis(fig[1, col],
        title="t = $t min",
        aspect=DataAspect())
    fireplot!(ax, g)
    hidedecorations!(ax)
end
fig
```

## References

- Osher, S. & Sethian, J.A. (1988). *Fronts propagating with curvature-dependent speed.* J. Computational Physics, 79(1), 12–49.
- Mallet, V., Keyes, D.E., & Fendell, F.E. (2009). *Modeling wildland fire propagation with level set methods.* Computers & Mathematics with Applications.
